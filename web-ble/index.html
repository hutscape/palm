<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">

<h1>Web Bluetooth: Read Characteristic Value Changed</h1>

<p>
  For BLE GATT Service
  <code>environmental_sensing</code>
  and BLE GATT Characteristic
  <code>uv_index</code>
</p>

<button id="read-env">Read UV Index</button>
<button id="start-env" disabled>Start</button>
<button id="stop-env" disabled>Stop</button>
<button id="reset-env">Reset device</button>

<p>
  For BLE GATT Service
  <code>battery_service</code>
  and BLE GATT Characteristic
  <code>battery_level</code>
</p>

<button id="read-batt">Read Battery level</button>
<button id="start-batt" disabled>Start</button>
<button id="stop-batt" disabled>Stop</button>
<button id="reset-batt">Reset device</button>

<script>
  var bluetoothDevice;
  var gattCharacteristic;
  var currentGatt;
  var gatt = {
    env: {
      serviceName: "UV Index",
      shortName: "env",
      service: "environmental_sensing",
      characteristic: "uv_index",
      unit: ""
    },
    batt: {
      serviceName: "Battery level",
      shortName: "batt",
      service: "battery_service",
      characteristic: "battery_level",
      unit: "%"
    }
  }

  // User actions read, start, stop, reset
  document.querySelector('#read-env').addEventListener('click', function() {
    if (isWebBluetoothEnabled()) { currentGatt = 'env'; read() }
  })

  document.querySelector('#start-env').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { start() }
  })

  document.querySelector('#stop-env').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { stop() }
  })

  document.querySelector('#reset-env').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { currentGatt = ''; reset() }
  })

  document.querySelector('#read-batt').addEventListener('click', function() {
    if (isWebBluetoothEnabled()) { currentGatt = 'batt'; read() }
  })

  document.querySelector('#start-batt').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { start() }
  })

  document.querySelector('#stop-batt').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { stop() }
  })

  document.querySelector('#reset-batt').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { currentGatt = ''; reset() }
  })

  function isWebBluetoothEnabled() {
    if (navigator.bluetooth) {
      return true;
    } else {
      console.log('Web Bluetooth API is not available.')
      console.log('Please make sure the "Experimental Web Platform features" flag is enabled.')
      return false
    }
  }

  function read() {
    return (bluetoothDevice ? Promise.resolve() : requestDevice())
    .then(connectGATT)
    .then(_ => {
      console.log('Reading ' + gatt[currentGatt].serviceName + '...');
      return gattCharacteristic.readValue();
    })
    .catch(error => {
      console.log('[ERROR] Read ' + gatt[currentGatt].serviceName + ' on click: ' + error);
    });
  }

  function start() {
    console.log('Starting Notifications...');
    gattCharacteristic.startNotifications()
    .then(_ => {
      console.log('> Notifications started');
      document.querySelector('#start-' + gatt[currentGatt].shortName).disabled = true;
      document.querySelector('#stop-' + gatt[currentGatt].shortName).disabled = false;
    })
    .catch(error => {
      console.log('[ERROR] Start notifications: ' + error);
    });
  }

  function stop() {
    console.log('Stopping Notifications...');
    gattCharacteristic.stopNotifications()
    .then(_ => {
      console.log('> Notifications stopped');
      document.querySelector('#start-' + gatt[currentGatt].shortName).disabled = false;
      document.querySelector('#stop-' + gatt[currentGatt].shortName).disabled = true;
    })
    .catch(error => {
      console.log('[ERROR] Stop notifications: ' + error);
    });
  }

  function reset() {
    if (gattCharacteristic) {
      gattCharacteristic.removeEventListener('characteristicvaluechanged',
          handleChangedValue);
      gattCharacteristic = null;
    }

    bluetoothDevice = null;
    document.querySelector('#start-batt').disabled = true;
    document.querySelector('#stop-batt').disabled = true;
    document.querySelector('#start-env').disabled = true;
    document.querySelector('#stop-env').disabled = true;

    console.log('> Bluetooth Device reset');
  }

  function connectGATT() {
    if (bluetoothDevice.gatt.connected && gattCharacteristic) {
      return Promise.resolve();
    }

    console.log('Connecting to GATT Server...');
    return bluetoothDevice.gatt.connect()
    .then(server => {
      console.log('Getting GATT Service...');
      return server.getPrimaryService(gatt[currentGatt].service);
    })
    .then(service => {
      console.log('Getting GATT Characteristic...');
      return service.getCharacteristic(gatt[currentGatt].characteristic);
    })
    .then(characteristic => {
      gattCharacteristic = characteristic;
      gattCharacteristic.addEventListener('characteristicvaluechanged',
          handleChangedValue);
      document.querySelector('#start-' + gatt[currentGatt].shortName).disabled = false;
      document.querySelector('#stop-' + gatt[currentGatt].shortName).disabled = true;
    });
  }

  function requestDevice() {
    console.log('Requesting any Bluetooth Device...');
    return navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [gatt[currentGatt].service]})
    .then(device => {
      bluetoothDevice = device;
      bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
    });
  }

  function handleChangedValue(event) {
    let value = event.target.value.getUint8(0);
    var now = new Date()
    console.log('> ' + now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + ' ' + gatt[currentGatt].serviceName + ' is ' + value + gatt[currentGatt].unit);

    if (currentGatt == 'env') { changeBackground(value) }
  }

  function onDisconnected() {
    console.log('> Bluetooth Device disconnected');
    connectGATT()
    connectGATTBatt()
    .catch(error => {
      console.log('[ERROR] on disconnected:  ' + error);
    })
  }

  function changeBackground(value) {
    if (value <= 2) {
      document.body.style.background = "yellowgreen"
    } else if (value <= 5) {
      document.body.style.background = "lemonchiffon"
    } else if (value <= 7) {
      document.body.style.background = "tomato"
    } else if (value <= 10) {
      document.body.style.background = "indianred"
    } else {
      document.body.style.background = "plum"
    }
  }
</script>
