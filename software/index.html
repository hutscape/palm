<style> code{ background: #eee; }</style>

<h1>Web Bluetooth: Read Characteristic Value Changed</h1>

<p>
  For BLE GATT Service
  <code><span id="ble-service-env">environmental_sensing</span></code>
  and BLE GATT Characteristic
  <code><span id="ble-characteristic-uv">uv_index</span></code>
</p>

<button id="read-env">Read UV Index</button>
<button id="start-env" disabled>Start</button>
<button id="stop-env" disabled>Stop</button>
<button id="reset-env">Reset device</button>

<p>
  For BLE GATT Service
  <code><span id="ble-service-batt">battery_service</span></code>
  and BLE GATT Characteristic
  <code><span id="ble-characteristic-batt-level">battery_level</span></code>
</p>

<button id="read-batt">Read Battery level</button>
<button id="start-batt" disabled>Start</button>
<button id="stop-batt" disabled>Stop</button>
<button id="reset-batt">Reset device</button>

<script>
  var bluetoothDevice;
  var gattCharacteristic;
  var currentGatt;
  var gatt = {
    env: {
      serviceName: "UV Index",
      shortName: "env",
      service: "environmental_sensing",
      characteristic: "uv_index"
    },
    batt: {
      serviceName: "Battery level",
      shortName: "batt",
      service: "battery_service",
      characteristic: "battery_level"
    }
  }

  var bleServiceEnv = document.getElementById("ble-service-env").innerText
  var bleCharacteristicUV = document.getElementById("ble-characteristic-uv").innerText
  var bleServiceBatt = document.getElementById("ble-service-batt").innerText
  var bleCharacteristicBattLevel = document.getElementById("ble-characteristic-batt-level").innerText

  // User actions read, start, stop, reset
  document.querySelector('#read-env').addEventListener('click', function() {
    if (isWebBluetoothEnabled()) { currentGatt = 'env'; read() }
  })

  document.querySelector('#start-env').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { onStart() }
  })

  document.querySelector('#stop-env').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { onStop() }
  })

  document.querySelector('#reset-env').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { currentGatt = ''; onReset() }
  })

  document.querySelector('#read-batt').addEventListener('click', function() {
    if (isWebBluetoothEnabled()) { currentGatt = 'batt'; readBatt() }
  })

  document.querySelector('#start-batt').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { onStartBatt() }
  })

  document.querySelector('#stop-batt').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { onStopBatt() }
  })

  document.querySelector('#reset-batt').addEventListener('click', function(event) {
    if (isWebBluetoothEnabled()) { currentGatt = ''; onReset() }
  })

  function isWebBluetoothEnabled() {
    if (navigator.bluetooth) {
      return true;
    } else {
      console.log('Web Bluetooth API is not available.')
      console.log('Please make sure the "Experimental Web Platform features" flag is enabled.')
      return false
    }
  }

  function read() {
    return (bluetoothDevice ? Promise.resolve() : requestDevice())
    .then(connectGATT)
    .then(_ => {
      console.log('Reading ' + gatt[currentGatt].serviceName + '...');
      return gattCharacteristic.readValue();
    })
    .catch(error => {
      console.log('[ERROR] Read on click: ' + error);
    });
  }

  function readBatt() {
    return (bluetoothDevice ? Promise.resolve() : requestDeviceBatt())
    .then(connectGATTBatt)
    .then(_ => {
      console.log('Reading ' + gatt[currentGatt].serviceName + '...');
      return gattCharacteristic.readValue();
    })
    .catch(error => {
      console.log('[ERROR] Read on click: ' + error);
    });
  }

  function requestDevice() {
    console.log('Requesting any Bluetooth Device...');
    return navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [gatt[currentGatt].service]})
    .then(device => {
      bluetoothDevice = device;
      bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
    });
  }

  function requestDeviceBatt() {
    console.log('Requesting any Bluetooth Device...');
    return navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [gatt[currentGatt].service]})
    .then(device => {
      bluetoothDevice = device;
      bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
    });
  }

  function connectGATT() {
    if (bluetoothDevice.gatt.connected && gattCharacteristic) {
      return Promise.resolve();
    }

    console.log('Connecting to GATT Server...');
    return bluetoothDevice.gatt.connect()
    .then(server => {
      console.log('Getting GATT Service...');
      return server.getPrimaryService(gatt[currentGatt].service);
    })
    .then(service => {
      console.log('Getting GATT Characteristic...');
      return service.getCharacteristic(gatt[currentGatt].characteristic);
    })
    .then(characteristic => {
      gattCharacteristic = characteristic;
      gattCharacteristic.addEventListener('characteristicvaluechanged',
          handleChangedValue);
      document.querySelector('#start-' + gatt[currentGatt].shortName).disabled = false;
      document.querySelector('#stop-' + gatt[currentGatt].shortName).disabled = true;
    });
  }

  function connectGATTBatt() {
    if (bluetoothDevice.gatt.connected && gattCharacteristic) {
      return Promise.resolve();
    }

    console.log('Connecting to GATT Server...');
    return bluetoothDevice.gatt.connect()
    .then(server => {
      console.log('Getting GATT Service...');
      return server.getPrimaryService(gatt[currentGatt].service);
    })
    .then(service => {
      console.log('Getting GATT Characteristic...');
      return service.getCharacteristic(gatt[currentGatt].characteristic);
    })
    .then(characteristic => {
      gattCharacteristic = characteristic;
      gattCharacteristic.addEventListener('characteristicvaluechanged',
          handleChangedValue);
      document.querySelector('#start-' + gatt[currentGatt].shortName).disabled = false;
      document.querySelector('#stop-' + gatt[currentGatt].shortName).disabled = true;
    });
  }

  function handleChangedValue(event) {
    let value = event.target.value.getUint8(0);
    var now = new Date()
    console.log('> ' + now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + ' ' + gatt[currentGatt].serviceName + ' is ' + value);
  }

  function onStart() {
    console.log('Starting Notifications...');
    gattCharacteristic.startNotifications()
    .then(_ => {
      console.log('> Notifications started');
      document.querySelector('#start-' + gatt[currentGatt].shortName).disabled = true;
      document.querySelector('#stop-' + gatt[currentGatt].shortName).disabled = false;
    })
    .catch(error => {
      console.log('[ERROR] Start notifications: ' + error);
    });
  }

  function onStartBatt() {
    console.log('Starting Notifications...');
    gattCharacteristic.startNotifications()
    .then(_ => {
      console.log('> Notifications started');
      document.querySelector('#start-' + gatt[currentGatt].shortName).disabled = true;
      document.querySelector('#stop-' + gatt[currentGatt].shortName).disabled = false;
    })
    .catch(error => {
      console.log('[ERROR] Start notifications: ' + error);
    });
  }

  function onStop() {
    console.log('Stopping Notifications...');
    gattCharacteristic.stopNotifications()
    .then(_ => {
      console.log('> Notifications stopped');
      document.querySelector('#start-' + gatt[currentGatt].shortName).disabled = false;
      document.querySelector('#stop-' + gatt[currentGatt].shortName).disabled = true;
    })
    .catch(error => {
      console.log('[ERROR] Stop notifications: ' + error);
    });
  }

  function onStopBatt() {
    console.log('Stopping Notifications...');
    gattCharacteristic.stopNotifications()
    .then(_ => {
      console.log('> Notifications stopped');
      document.querySelector('#start-' + gatt[currentGatt].shortName).disabled = false;
      document.querySelector('#stop-' + gatt[currentGatt].shortName).disabled = true;
    })
    .catch(error => {
      console.log('[ERROR] Stop notifications: ' + error);
    });
  }

  function onReset() {
    if (gattCharacteristic) {
      gattCharacteristic.removeEventListener('characteristicvaluechanged',
          handleChangedValue);
      gattCharacteristic = null;
    }

    bluetoothDevice = null;
    document.querySelector('#start-batt').disabled = true;
    document.querySelector('#stop-batt').disabled = true;
    document.querySelector('#start-env').disabled = true;
    document.querySelector('#stop-env').disabled = true;

    console.log('> Bluetooth Device reset');
  }

  function onDisconnected() {
    console.log('> Bluetooth Device disconnected');
    connectGATT()
    connectGATTBatt()
    .catch(error => {
      console.log('[ERROR] on disconnected:  ' + error);
    })
  }
</script>
